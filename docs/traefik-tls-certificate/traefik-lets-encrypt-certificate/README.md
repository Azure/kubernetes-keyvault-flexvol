# Using a Let's Encrypt certificate to setup an SSL entrypoint with Traefik

## Prerequisits

- The following steps assumes that you have an Azure Keyvault, and flexvol setup on your kubernetes cluster.
- For the purpose of this documentation, We've created a free https certificate using (gethttpsforfree.com)[https://gethttpsforfree.com/]
- You'll need to convert the private key (domain.key) generated by this website to be pkcs8 format using the following command

```bash
openssl pkcs8 -topk8 -inform PEM -outform PEM -nocrypt -in domain.key -out pkcs8.key
```

- You'll need to create .pem file which will have certificates created followed by the pkcs8 key in the following format so you can import the certificate to KeyVault.

```pem
-----BEGIN CERTIFICATE-----
<Your certificate>
-----END CERTIFICATE-----
-----BEGIN PRIVATE KEY-----
<Your pkcs8 private key>
-----END PRIVATE KEY-----
```

- Import the certificate (.pem) to KeyVault as following:

```bash
az keyvault certificate import --vault-name "KV-name" --name "certificate-name" --file "./file-name.pem"
```

## Deploy Traefik to AKS

The yaml file configures a Traefik ingress controller, with a certificate from Let's Encrypt as default TLS certificate.

### Volumes

We used service principle option:

```yaml
- name: ssl
        emptyDir: {}
      - name: certs
        flexVolume:
          driver: "azure/kv"
          secretRef:
            name: kvcreds
          options:
            keyvaultname: "######"
            keyvaultobjectname: "####"
            keyvaultobjecttype: "secret"
            tenantid: "##############"
            usepodidentity: "false"
```

__certs__: the flexVolume that fetches the certificate. We download it as a _*secret*_ to retrieve both the private and public part required for setting up TLS.

__ssl__ : An emptyDir volume that translates to a tmpfs mount accessible only by this pod. We will use it to store the converted format of the certificate.
Containers

#### initContainer

Traefik (and most ingresses), requires the certificate as PEM + private key pair format. We need to extract both from the .pem file retreived from KeyVault before starting Traefik. This is what the initContainer is doing :

```yaml
initContainers:
    - image: tannerfe/alpine-openssl
    name: convert-certs
    command: ['sh', '-c', 'openssl x509 -in /certs/<certificate-name> -out /ssl/certificate.pem &&
    openssl pkey -in /certs/certificate-name> -out /ssl/certificate.key']
    volumeMounts:
    - name: certs
        mountPath: /certs
        readOnly: true
    - name: ssl
        mountPath: /ssl
```

We use an alpine based openssl container. First, We need to mount the certs volume which is our readOnly flexvolume with KeyVault certificate and then write to the ssl volume

### Traefik container

In the Traefik container, we mount the ssl volume alongside Traefik config volume from the configmap. The toml configuration refers to the converted PEM and Key files in the ssl volume to setup the default TLS certificate :

```toml
[entryPoints.https]
    address = ":443"
    [entryPoints.https.tls]
    [entryPoints.https.tls.defaultCertificate]
        certFile = "/ssl/certificate.pem"
        keyFile = "/ssl/certificate.key"
```