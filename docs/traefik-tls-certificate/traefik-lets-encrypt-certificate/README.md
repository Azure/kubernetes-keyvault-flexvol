# Using a Let's Encrypt certificate to setup an SSL entrypoint with Traefik

## Prerequisits

- The following steps assumes that you have an Azure Keyvault, and flexvol setup on your kubernetes cluster.
- For the purpose of this documentation, We've created a free https certificate using (gethttpsforfree.com)[https://gethttpsforfree.com/]
- You'll need to convert the private key (domain.key) generated by this website to be pkcs8 format using the following command

```bash
openssl pkcs8 -topk8 -inform PEM -outform PEM -nocrypt -in domain.key -out pkcs8.key
```

- You'll need to import 2 secrets in KV; certificates followed by the pkcs8 key to KeyVault as following:

```bash
az keyvault secret set --vault-name "KV-name" -n "tls-key" -f tls-key.key
az keyvault secret set --vault-name "KV-name" -n "tls-pem" -f tls-pem.pem
```

### Deploy Traefik to AKS

The yaml file configure a Traefik ingress controller, with a certificate from Let's Encrypt as default TLS certificate.

#### Volumes

We used pod identity option:

```yaml
      - name: certs
        flexVolume:
          driver: "azure/kv"
          secretRef:
            name: kvcreds
          options:
            keyvaultname: "######"
            keyvaultobjectname: ####;####
            keyvaultobjecttype: secret;secret
            keyvaultobjectaliases: tls-pem.pem;tls-key.key
            tenantid: "##############"
            usepodidentity: "true"
```

__certs__: the flexVolume that fetches the private and public part required for setting up TLS.

### Traefik container

In the Traefik container, we mount the ssl volume alongside Traefik config volume from the configmap. The toml configuration refers to the converted PEM and Key files in the ssl volume to setup the default TLS certificate :

```toml
[entryPoints.https]
    address = ":443"
    [entryPoints.https.tls]
    [entryPoints.https.tls.defaultCertificate]
        certFile = "/certs/tls-pem.pem"
        keyFile = "/certs/tls-key.key"
```